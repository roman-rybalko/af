* локальные порты 25 137 138 139 445

* получение системной настройки trustedports (137 138 139 445)
** received_port in trustedports => sys_trustedport
sys_trustedport

* получение системной настройки spamtrap
** ok => sys_spamtrap
sys_spamtrap

* получение системной настройки hamtrap
** ok => sys_hamtrap
sys_hamtrap (исп. в роутерах)

* получение системной настройки mailboxtimeout
sys_mailboxtimeout

* получение системной настройки trustedmessagesize
sys_trustedmessagesize

connect
* ok

helo
* ok

mail
* проверка spf
** fail => flag_spf
* проверка системных списков фильтрации => flag_sys_wl, flag_sys_bl, msg_sys_wbl
* ok
flag_spf
flag_sys_wl
flag_sys_bl
msg_sys_wbl

rcpt
* проверка realm для домена
** нет домена => 5xx The domain is not in service, stop
** чужой realm => 4xx Moved, please try another host, stop
* получение пользовательской настройки user_nombxchk (NoMailBoxCheck - no auto-add)
* проверка адреса получателя в afMailBox (с учетом MailBox Timeout)
** absent && sys_spamtrap => 2xx OK Mail box does not exist, flag_mb_absent, stop
** absent => 5xx Mail box does not exist, stop
** (expired || not_found) && user_nombxchk && sys_spamtrap => 2xx OK Mail box does not exist, flag_mb_absent, stop
** (expired || not_found) && user_nombxchk => 5xx Mail box does not exist, stop
** expired || not_found => 4xx Your data is verifying, please try again later, log, stop
** ok
* recipients_count > 0 => 4xx Mail box is temporarily unavailable, please try again later
recipients_count - параметр exim, количество ответов 2xx на RCPT
* получение пользовательской настройки user_spt (Spam PassThrough)
* проверка пользовательских списков фильтрации => flag_user_wl, flag_user_bl, msg_user_wbl
* flag_user_wl => 2xx OK ($msg_user_wbl), stop
* flag_user_bl => 5xx Access denied ($msg_user_wbl), stop
* flag_sys_wl => 2xx OK ($msg_sys_wbl), stop
* flag_sys_bl && !sys_spamtrap && !user_spt => 5xx Access denied ($msg_sys_wbl), stop
* flag_sys_bl => 2xx OK ST/SPT ($msg_sys_wbl), stop
* flag_spf && !user_spt && !sys_spamtrap => 5xx Access denied (SPF: ...), stop
* flag_spf => 2xx OK ST/SPT (SPF: ...), stop
ST, SPT - короткие аббревиатуры для тестов без раскрытия смысла
* ok
flag_mb_absent
flag_user_bl
flag_user_wl
msg_user_wbl

data
* ok

data_end
* flag_mb_absent => fake/5xx Mail box does not exist, stop, flag_spamtrap
* flag_user_wl => 2xx OK ($msg_user_wbl), stop
* flag_sys_wl => 2xx OK ($msg_sys_wbl), stop
* flag_sys_bl && user_spt => 2xx OK ST/SPT ($msg_sys_wbl), stop, flag_spamtrap, flag_spam
* flag_sys_bl => fake/5xx Access denied ($msg_sys_wbl), stop, flag_spamtrap, flag_spam
* flag_spf && user_spt => 2xx OK ST/SPT (SPF: ...), stop, flag_spamtrap, flag_spam
* flag_spf => fake/5xx Access denied (SPF: ...), stop, log Message-ID, flag_spamtrap, flag_spam
# * sys_trustedport => 2xx OK, stop
На trusted port шлют правильные почтовики и именно они рассылают спам, который возможно определить только контентными методами.
* проверка Message-Id в afMessageIncoming
** нет MessageId && user_spt => 2xx OK SPT (No Message-ID header), stop, flag_spam
** нет MessageId => 5xx Access denied (No Message-ID header), stop
** ok, afIsSpam && user_spt => 2xx OK SPT ($afSpamDescription), stop, flag_spam
** ok, afIsSpam => 5xx Access denied ($afSpamDescription), stop
** не совпадает sender && user_spt => 2xx OK SPT (Several senders for the same message), stop, flag_spamtrap, flag_spam
** не совпадает sender && sys_spamtrap => fake/5xx Access denied (Several senders for the same message), stop, flag_spamtrap, flag_spam
** не совпадает sender => 5xx Access denied (Several senders for the same message), stop, flag_spamtrap, flag_spam
** ok => 2xx OK, stop
* проверка In-Reply-To, References в afMessageOutgoing
** ok => 2xx OK, stop, flag_hamtrap
* message_size >= sys_trustedmessagesize
** ok => 2xx OK (TMS), stop
TMS - Trusted Message Size
* 4xx Your data is verifying, please try again later, flag_mailproc
flag_spam
flag_spamtrap
flag_mailproc
flag_hamtrap
