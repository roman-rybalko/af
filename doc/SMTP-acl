* локальные порты 25 137 138 139 445

* получение системной настройки trustedports (137 138 139 445)
** received_port in trustedports => sys_trustedport
sys_trustedport

* получение системной настройки spamtrap
** ok => sys_spamtrap
sys_spamtrap

* получение системной настройки hamtrap
** ok => sys_hamtrap
sys_hamtrap (исп. в роутерах)

* получение системной настройки mailboxtimeout
sys_mailboxtimeout

* получение системной настройки trustedmessagesize
sys_trustedmessagesize

connect
* ok

helo
* ok

mail
* проверка spf
** fail => flag_spf
* проверка системных списков фильтрации => flag_sys_wl, flag_sys_bl, msg_sys_wbl
* ok
flag_spf
flag_sys_wl
flag_sys_bl
msg_sys_wbl

rcpt
* проверка realm для домена
** нет домена => 5xx The domain is not in service, stop
** чужой realm => 4xx Moved, please try another host, stop
* проверка адреса получателя в afMailBox (с учетом MailBox Timeout)
** fail => 4xx Your data is verifying, please try again later, log, stop
** ok, absent => sys_spamtrap ? ok Mail box does not exist, flag_mb_absent, stop : 5xx Mail box does not exist, stop
* recipients_count > 0 => 4xx Mail box is temporarily unavailable, please try again later
recipients_count - параметр exim, количество ответов 2xx на RCPT
* получение пользовательских настроек user_spt (Spam PassThrough)
* проверка пользовательских списков фильтрации => flag_user_wl, flag_user_bl, msg_user_wbl
* flag_user_wl => ok $msg_user_wbl, stop
* flag_user_bl => 5xx $msg_user_wbl, stop
* flag_sys_wl => ok $msg_sys_wbl, stop
* flag_sys_bl && !sys_spamtrap && !user_spt => 5xx $msg_sys_wbl, stop
* flag_sys_bl => ok ST/SPT $msg_sys_wbl, stop
* flag_spf && !user_spt && !sys_spamtrap => 5xx Access denied (SPF: ...), stop
* flag_spf => ok ST/SPT (SPF: ...), stop
ST, SPT - короткие аббревиатуры для тестов без раскрытия смысла
* ok
flag_mb_absent
flag_user_bl
flag_user_wl
msg_user_wbl

data
* ok

data_end
* flag_mb_absent => 5xx Mail box does not exist, stop, flag_spamtrap
* flag_sys_bl || flag_spf => flag_spamtrap
* flag_user_wl => ok $msg_user_wbl, stop
* flag_sys_wl => ok $msg_sys_wbl, stop
* flag_sys_bl => 5xx $msg_sys_wbl, stop, flag_spam
* flag_spf => 5xx SPF: ..., stop, log Message-ID, flag_spam
#* sys_trustedport => ok, stop
На trusted port шлют правильные почтовики и именно они рассылают спам, который возможно определить только контентными методами.
* проверка Message-Id в afMessageIncoming
** нет MessageId => 5xx No Message-ID header, stop
** ok, afIsSpam => 5xx SPAM: $afSpamDescription, stop
** не совпадает sender => 5xx Several senders for the same message, stop, flag_spamtrap
** ok => ok, stop
* проверка In-Reply-To, References в afMessageOutgoing
** ok => ok, stop, flag_hamtrap
* message_size >= sys_trustedmessagesize
** ok => ok TMS, stop
TMS - Trusted Message Size
* 4xx Your data is verifying, please try again later, flag_mailproc
flag_spam
flag_spamtrap
flag_mailproc
flag_hamtrap
