* локальные порты 25 137 138 139 445

* получение системной настройки trustedports (137 138 139 445)
** received_port in trustedports => sys_trustedport
sys_trustedport

* получение системной настройки spamtrap
** ok => sys_spamtrap
sys_spamtrap

* получение системной настройки mailboxtimeout
sys_mailboxtimeout

* получение системной настройки trustedmessagesize
sys_trustedmessagesize

connect
* ! sys_trustedport => проверка dnsbl
** fail => flag_dnsbl
* ok
flag_dnsbl

helo
* ok

mail
* проверка spf
** fail => flag_spf
* проверка системных списков фильтрации => ok/fail, descr





TODO ...






* ok
flag_spf

rcpt
* проверка realm для домена
** нет домена => 5xx The domain is not in service, stop
** чужой realm => 4xx Moved, try another host, stop
* проверка адреса получателя в afMailBox (с учетом MailBox Timeout)
** fail => 4xx Your data is verifying, try again later, log, stop
** ok, absent => sys_spamtrap ? ok, msg_spamdescr+="<recipient>: Mail box does not exist", stop : 5xx Mail box does not exist, stop
* получение пользовательских настроек user_spt (Spam PassThrough), user_no_spf, user_no_dnsbl
* проверка пользовательских списков фильтрации => ok/fail, descr
** user ok => ok $descr, flag_wl+=1, stop
** user fail => 5xx $descr, stop
* flag_spf && !user_no_spf => msg_spamdescr+="<recipient>: Access denied (SPF: ...)"
* flag_dnsbl && !user_no_dnsbl => msg_spamdescr+="<recipient>: Access denied (DNSBL: ...)"
* sys_spamtrap && msg_spamdescr => ok, stop
* user_spt && msg_spamdescr => ok, stop
* msg_spamdescr => 5xx $msg_spamdescr, stop
* ok
msg_spamdescr
flag_user_wl
flag_user_spt

data
* ok

http://www.jwz.org/doc/threading.html

data_end
* flag_sys_wl => ok, stop, log message-id
* flag_user_wl == recipients_count => ok, stop
* sys_spamtrap && msg_spamdescr => ok, stop, log message-id
#* sys_trustedport => ok, stop, log message-id
На trusted port шлют правильные почтовики и именно они рассылают спам, который определить только контентными методами.
* проверка Message-Id в afMessageIncoming
** нет MessageId => 5xx SPAM: No Message-ID header, stop
** ok, afIsSpam => 5xx SPAM: afSpamDescription, stop
** не совпадает sender => 5xx SPAM: Several senders for the same Message-ID, stop, spamtrap
** ok => ok, stop
* проверка In-Reply-To, References в afMessageOutgoing
** ok => ok, stop, hamtrap, log message-id
* message_size >= sys_trustedmessagesize
** ok => ok, stop, log message-id
* 4xx Your data is verifying, try again later, mailproc

* flag_user_spt == recipients_count => ok, stop
* flag_spamtrap => 5xx $flag_spamtrap, stop
