Прием на портах 25 137 138 139 445.
Порт 587 - проверка адреса для submission, наш сертификат, проверка по нашему ЦС, отключены RBL SPF и прочий антиспам, укороченный таймаут для ящика.
Spam Trap - отправка сообщений в spamtrap с вероятностью из системных настроек.
Системные и пользовательские ч/б списки. ч/б списки по IP, hostname, адресу отправителя в сессии, полю Subject сертификата. Проверка сначала черного списка затем белого.
Пользовательские ч/б списки для клиента, домена и ящика.
MX для клиента, домена и ящика.

- Проблема:
Как реализовать политики пользователя - сообщение может напрявляться нескольким пользователям и у них могут быть конфликтующие политики.
Часть пользователей приняли сообщение, часть отвергли.
+ Решение:
Принимать только 1 получателя, остальных отвергать с кодом 452 (или другим 4xx).
Сервер-отправитель должен перепослать сообщение для каждого временно недоставленного получателя.
Это решает проблему с конфликтующими политиками и затребует от отправителя больше ресурсов (что отпугнет спамеров).

- Проблема:
Нет возможности в аутентификаторе Exim определить порт получателя, а значит не понятно как достать из БД логин/пароль.
+ Решение:
Exim доработан - добавлена переменная $smtp_host_specific_port (smtp_host_specific_port-4.80.1.patch).

- Проблема:
Exim требует дополнительное экранирование в route_data.
route_data = \"<! host1.com!host2.com:587\"
Нет возможности с этим синтаксисовм задать пустой список.
route_data = \"<! \" # ошибка
+ Решение:
Проверять содержимое списка.
route_data = ${if bool_lax{LIST}{\"<! LIST\"}{}}

- Проблема:
route_list не позволяет задать пустой список
route_list = * "<! host1.com!host2.com:587"
route_list = ${if bool_lax{LIST}{* "<! LIST"}{}} - не работает
+ Решение: не используем route_list, используем только когда всегда есть данные

- Проблема:
Возможно зацикливание сообщений. Клиент может настроить циклические переадресации или задать наш сервер как свой MX.
+ Решение:
Добавить заголовок
X-AdvancedFiltering-Via: sender@ sender@ sender@
в smtp/mx и smtp/submission. Подписать DKIM.
При каждой пересылке в этот заголовок добавлять текущий sender_address.
При каждом приеме искать в этом заголовке цикл. Наиболее простой способ поиска цикла: сравнить первую и вторую половину.
При обнаружении цикла отвергать с 5xx.
Проверку делать в acl_smtp_dkim.

- Проблема:
При переадресации теряется информация об оригинальном отправителе (IP, mail from, Certificate).
Возможно настроить спам-рассылку на соседей отбелив спам-отправителя и задав Backup.
+ Решение:
Добавить заголовки
X-AdvancedFiltering-Original-Sender-Mail-Address: sender@test.com
X-AdvancedFiltering-Original-Sender-Host-Address: 1.2.3.4
X-AdvancedFiltering-Original-Sender-Host-Name: mx.test.com
X-AdvancedFiltering-Original-Sender-Certificate-Subject: <base64>
X-AdvancedFiltering-Original-Sender-Certificate-Verified: (TRUE/FALSE)
X-AdvancedFiltering-Original-SPF-Pass: (TRUE/FALSE)
X-AdvancedFiltering-Original-SPF-Description: <base64>
X-AdvancedFiltering-Original-Spam-Pass: (TRUE/FALSE)
X-AdvancedFiltering-Original-Spam-Description: <base64>
в smtp/submission. Подписать DKIM.
Нет смысла в smtp/mx - mx не может быть настроен для сокрытия отправителя (на данный момент).
Добавлять заголовки для каждого нового параметра списков доступа (bwlist).
Текстовые поля, где могут содержаться пробелы, кодировать в base64 (DKIM формируется relaxed (некоторые MTA,
как MS Exchange, перекодируют тело сообщения в base64, заголовки тоже, теоретически, могут быть изменены) - возможно
изменение количества пробелов, что приведет к несопоставлению в ч/б-списках).
При обнаружении нашей (dkim.advancedfiltering.net) подписи делать доп. проверку по ч/б-спискам. Текущие параметры
отправителя не обновлять - для отправки на mx использовать адрес отправителя из текущей SMTP-сессии.
Проверку делать в acl_smtp_dkim.
Spam-Pass/Spam-Description может отсутствовать. При наличии повторную спам-проверку не делать.
