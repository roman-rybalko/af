TODO: retry config (per domain/mx target - whichever possible)
TODO: SMTP-mdb доделать (новый атрибут для incoming, его проверка, изменить проверку sender)
TODO: DKIM check (добавить DKIM-подписавшие домены в системные и пользовательсике ч/б списки)
TODO: логирование приема, отправки, ошибки 5xx и 4хх
TODO: учитывать время создания записи MailBox
TODO: чистить записи MessageId (спустя сутки или неделю)
TODO: размер сообщения

* локальные порты 25 137 138 139 445

* получение системной настройки trustedports (137 138 139 445)
** received_port in trustedports => sys_trustedport
sys_trustedport

* получение системной настройки spamtrap
** ok => sys_spamtrap
sys_spamtrap

connect
* проверка системных черных списков (ip, hostname)
** ok => sys_spamtrap ? ok, flag_spamtrap+="Access denied (local system policy)", stop : 5xx Access denied (local system policy), stop
* проверка системных белых списков (ip, hostname)
** ok => flag_sys_wl, ok, stop
* sys_trustedport ? ok : проверка dnsbl
** fail => flag_dnsbl
* ok
flag_spamtrap
flag_sys_wl
flag_dnsbl

helo
* flag_sys_wl => ok, stop
* flag_spamtrap => ok, stop
* проверка сертификата
** fail => flag_cert
* проверка системных черных списков (certificate)
** ok => sys_spamtrap ? ok, flag_spamtrap+="5xx Access denied (local system policy)", stop : 5xx Access denied (local system policy), stop
* ! flag_cert => проверка системных белых списков (certificate)
** ok => flag_sys_wl, ok, stop
flag_spamtrap
flag_sys_wl

mail
* flag_sys_wl => ok, stop
* flag_spamtrap => ok, stop
* проверка spf
** fail => flag_spf
* проверка системных черных списков (addr from)
** ok => sys_spamtrap ? ok, flag_spamtrap+="5xx Access denied (local system policy)", stop : 5xx Access denied (local system policy), stop
* ! flag_spf => проверка системных белых списков (addr from)
** ok => flag_sys_wl, ok, stop
flag_spamtrap
flag_sys_wl
flag_spf

rcpt
* проверка realm для домена
** нет домена => 5xx The domain is not in service, stop
** чужой realm => 4xx Moved, try another host, stop
* проверка адреса получателя в afMailBox
** fail => 4xx Your data is verifying, try again in 5 minutes, log, stop
** ok, absent => sys_spamtrap ? ok, flag_spamtrap+="Mail box does not exist", stop : 5xx Mail box does not exist, stop
* проверка черных списков (ip, hostname, certificate) для [addr to, domain to, client to]
** ok => 5xx Access denied (local user policy), stop
* проверка белых списков (ip, hostname, certificate) для [addr to, domain to, client to]
** ok => flag_user_wl+=1, ok, stop
Проверить черный список для addr from имеет смысл даже без проверки SPF. Но делать отдельную проверку для черного списка
не эфективно. Белый список для addr from не имеет смысла до проверки SPF. Черный список для addr from не имеет смысла если
SPF обнаружил нарушение.
* flag_spf => sys_spamtrap ? ok, flag_spamtrap+="Access denied (SPF: ...)", stop : 5xx Access denied (SPF: ...), stop
* проверка черных списков (addr from) для [addr to, domain to, client to]
** ok => 5xx Access denied (local user policy), stop
* проверка белых списков (addr from) для [addr to, domain to, client to]
** ok => flag_user_wl+=1, ok, stop
* flag_dnsbl => sys_spamtrap ? ok, flag_spamtrap+="Access denied (DNSBL: ...)", stop : 5xx Access denied (DNSBL: ...), stop
flag_user_wl

data
* ok

http://www.jwz.org/doc/threading.html

data_end
* flag_spamtrap => 5xx $flag_spamtrap, stop
* flag_sys_wl => ok, stop
* flag_user_wl == recipients_count => ok, stop
#* sys_trustedport => ok, stop
На trusted port шлют правильные почтовики и именно они рассылают спам, который определить только контентными методами.
* проверка Message-Id в afMessageIncoming
** нет MessageId => 5xx Spam detected: No Message-ID header, stop
** ok, afIsSpam => 5xx Spam detected: afSpamDescription, stop
** ok => ok, stop
* проверка In-Reply-To, References в afMessageOutgoing
** ok => ok, stop
* 4xx Your data is verifying, try again in later, forward to mailproc
