* локальные порты 587

* получение системной настройки mailboxtimeout
sys_mailboxtimeout

* получение системной настройки размера сообщения для отключения проверки спама
sys_trustedmessagesize

* получить системную настройку максимаьного размера сообщения
sys_maxmessagesize

* установить сертификат
** trusted_host => внутренний сертификат (hostname.crt)
** задан клиентский сертификат => клиентский сертификат
** не задан клиентский сертификат => внешний сертификат (submission.services.advancedfiltering.net.crt)

* проверка адреса отправителя (user_sender_address)
** домен не задан => 5xx {user_sender_descr} address {user_sender_address} does not have a domain, stop
** домен не зарегистрирован => 5xx {user_sender_descr} domain {domain:user_sender_address} is not in service, stop
# не отображать владельца домена - раскрытие информации
** не наш realm домена => 4xx {user_sender_descr} domain {domain:user_sender_address} is moved, please try another host, stop
** домен не принимает почту (verify = sender) => 5xx {user_sender_descr} domain {domain:user_sender_address} does not accept mail, stop
** синоним => user_domain, continue
** двойной синоним => 4xx {user_sender_descr} domain {domain:user_sender_address} (alias to {user_domain}) has configuration problem (double domain alias), panic, stop
** не найден в ou=user => 4xx {user_sender_descr} domain {domain:user_sender_address} {синоним?(alias to {user_domain}):""} is replicating, please try again later, stop
** не зарегистрирован и не проверяется адрес отправителя => 5xx {user_sender_descr} address {user_sender_address} {синоним?(alias to {user_domain}):""} does not exist, stop
** просрочен адрес отправителя => записать в лог задание на проверку, flag_expired, continue
# не отображать синоним домена - раскрытие информации
** авторизация адреса отправителя => 5xx Authenticated user {user} may not use {user_sender_descr} address {user_sender_address}, stop
*** authz = trustedhost/mbox/domain/client/none
** нет DMARC (dmarc_verifier.pl "{domain:user_sender_address}") => 5xx DMARC is absent for {user_sender_descr} domain {domain:user_sender_address} ({error}), stop
** continue

* helo
** вывести аутентификационную информацию

mail
* идентифицировать клиента
# код ошибки 5xx - эту ошибку нужно обнаружить сразу и устранить (smtp отправит boucne на error@services)
** trusted_host && !certificate_verified => 5xx Trusted host certificate verification failed, stop
** trusted_host => continue
# код ошибки 5xx - эту ошибку нужно обнаружить сразу и устранить
# клиентский сертификат будет использован только если клиент определился по IP или TLS SNI
** использован клиентский сертификат && !certificate_verified => 5xx Client certificate verification failed, stop
** логин определился => continue
** 5xx Authentication needed, stop
* присутствует адрес отправителя => проверка адреса отправителя (Sender), continue
* trusted_host && отсутствует адрес отправителя => 5xx Trusted host is not allowed to send status notification (empty Envelope-Sender), stop
* отсутствует адрес отправителя => flag_spamsender, continue
* загрузить пользовательсике настройки (mbox/domain/client) => user_hidereceived, flag_spamsender, continue
* user_hidereceived => Удалить заголовки Received, continue
* Режим submission (добавить From если нет, Sender, Date, Message-ID) без проверки From:, continue
* 2xx {orig_sender_address} {client} {(authz)trustedhost/mbox/domain/client/none} {flag_spamsender} {user_hidereceived} {flag_expired}, stop

rcpt
* домен не принимает почту (verify = recipient) => 5xx Recipient domain {domain} does not accept mail, stop
* 2xx, stop

data_end
* message_size >= sys_maxmessagesize => 5xx ...
* синтаксис заголовоков некорректен (verify = header_syntax) => 5xx Invalid message headers (Sender/From/Reply-To/To/Cc/Bcc), stop
* есть заголовок X-AdvancedFiltering-MessageData-Submission => 5xx Message loop detected, stop
* заголовок From: содержит несколько адресов или битый => 5xx Invalid "From:" header, stop
* заголовок "From:" содержит один адрес => проверка адреса отправителя ("From:"), continue
# может быть домен, котрый не совпадает с mail from и тоже зарегистрирован в системе (relaxed DMARC или ошибка конфигурации)
* DMARC не проверился (dmarc_verifier.pl "from domain" "spf domain" "dkim domain") => 5xx DMARC failed for ("From:") domain {domain:header_from}, stop
* загрузить пользовательсике настройки (mbox/domain/client) => flag_spamsender, continue
* присутствует заголовок "Reply-To:" && содержит несколько адресов или битый => 5xx Invalid "Reply-To:" header, stop
* присутствует заголовок "Reply-To:" && домен в заголовке Reply-To: не принимает почту (verify = sender) => 5xx "Reply-To:" domain {domain:header_reply-to} does not accept mail, stop
# message-id всегда добавляется для этого соединения (режим submission)
* message-id в БД но sender другой => 5xx Duplicate, previous sender=prev-sender
* in-reply-to, references в БД и sender в recipients => flag_hamtrap, continue
* msgsize >= sys_trustedmessagesize => flag_trustedmessagesize, log (trusted size), 2xx Trusted message size, stop
* 2xx {id=exim_msg_id} {orig_sender_address} {client} {(authz)trustedhost/mbox/domain/client/none} {flag_spamsender} {flag_expired}, stop
