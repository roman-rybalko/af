* локальные порты 587

* получение системной настройки mailboxtimeout
sys_mailboxtimeout

* получение системной настройки размера сообщения для отключения проверки спама
sys_trustedmessagesize

* получить системную настройку максимаьного размера сообщения
sys_maxmessagesize

* установить сертификат
** trusted_host => внутренний сертификат (hostname.crt)
** client (IP) && задан клиентский сертификат => клиентский сертификат
** client (IP) => внешний сертификат (submission.services.advancedfiltering.net.crt)
** client (TLS SNI) && задан клиентский сертификат => клиентский сертификат
** client (TLS SNI) => внешний сертификат (submission.services.advancedfiltering.net.crt)

mail
* идентифицировать клиента
# код ошибки 5xx - эту ошибку нужно обнаружить сразу и устранить (smtp отправит boucne на error@services)
** trusted_host && !certificate_verified => 5xx Trusted host certificate verification failed, stop
** trusted_host => ok
# код ошибки 5xx - эту ошибку нужно обнаружить сразу и устранить
** IP (client) && задан клиентский сертификат && !certificate_verified => 5xx Client (IP) certificate verification failed, stop
** IP (client) => ok
** TLS SNI && задан клиентский сертификат && !certificate_verified => 5xx Client (TLS SNI) certificate verification failed, stop
** TLS SNI => ok
** SMTP AUTH (client/domain/rcpt) => ok
** fail => 5xx Authentication needed, stop
* проверить существование адреса отправителя (envelope)
** fail => 5xx Sender mail box does not exist, stop
* !trusted_host => проверить доступ к адресу отправителя (client/domain/rcpt)
* загрузить пользовательсике настройки => user_hidereceived, flag_spamsender

rcpt
* проверить существование домена получателя

data_end
* проверить адрес отправителя (From)
** нет домена => 5xx "From:" domain (domain:header_from) is not in service, stop
** не наш realm => 4xx "From:" domain moved, please try another host, stop
** fail => 5xx "From:" mail box (header_from) does not exist, stop
** ok
* проверить обратный адрес (Reply-To)
** нет домена => 5xx "Reply-To:" domain (domain:header_from) is not in service, stop
** не наш realm => 4xx "Reply-To:" domain moved, please try another host, stop
** fail => 5xx "Reply-To:" mail box (header_from) does not exist, stop
** ok
# message-id всегда добавляется для этого соединения
* проверить message-id+получатель
** в БД => 2xx Duplicate, previous id=prev-queue-id, discard, stop
** sender в БД но другой => 5xx Duplicate, previous sender=prev-sender
** ok
* user_hidereceived => убрать заголовки Received
* msgsize >= sys_trustedmessagesize => flag_trustedmessagesize, log (trusted size), ok, stop
