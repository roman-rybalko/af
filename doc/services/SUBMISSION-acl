* локальные порты 587

* получение системной настройки mailboxtimeout
sys_mailboxtimeout

* получение системной настройки размера сообщения для отключения проверки спама
sys_trustedmessagesize

* получить системную настройку максимаьного размера сообщения
sys_maxmessagesize

* установить сертификат
** trusted_host => внутренний сертификат (hostname.crt)
** client (IP) && задан клиентский сертификат => клиентский сертификат
** client (IP) => внешний сертификат (submission.services.advancedfiltering.net.crt)
** client (TLS SNI) && задан клиентский сертификат => клиентский сертификат
** client (TLS SNI) => внешний сертификат (submission.services.advancedfiltering.net.crt)

* проверка адреса отправителя
** домен не задан => 5xx Sender domain is absent, stop
** домен не зарегистрирован => 5xx Sender domain {domain:sender_address} is not in service, stop
** не наш realm домена => 4xx Moved, please try another host, stop
** домен не принимает почту (verify = sender) => 5xx Sender domain {domain:sender_address} does not accept mail, stop
** раскрыть синоним, continue
** не зарегистрирован (или просрочен) и не проверяется адрес отправителя => 5xx Sender address {sender_address} does not exist, stop
** !trusted_host && адрес отправителя не принадлежит аутентифицированному client/domain/rcpt => 5xx Authenticated user {user} may not use sender address {sender_address}, stop
** нет DMARC (dmarc_verifier.pl "{domain:sender_address}") => 5xx DMARC is absent for sender domain {domain:sender_address}, stop
** continue

mail
* идентифицировать клиента
# код ошибки 5xx - эту ошибку нужно обнаружить сразу и устранить (smtp отправит boucne на error@services)
** trusted_host && !certificate_verified => 5xx Trusted host certificate verification failed, stop
** trusted_host => continue
# код ошибки 5xx - эту ошибку нужно обнаружить сразу и устранить
** IP (client) && задан клиентский сертификат && !certificate_verified => 5xx Client (IP) certificate verification failed, stop
** IP (client) => continue
** TLS SNI && задан клиентский сертификат && !certificate_verified => 5xx Client (TLS SNI) certificate verification failed, stop
** TLS SNI => continue
** SMTP AUTH => continue
** 5xx Authentication needed, stop
* присутствует адрес отправителя => проверка адреса отправителя (Sender), continue
* отсутствует адрес отправителя => flag_spamsender, continue
* загрузить пользовательсике настройки (mbox/domain/client) => user_hidereceived, flag_spamsender, continue
* user_hidereceived => Удалить заголовки Received, continue
* Режим submission (добавить From если нет, Sender, Date, Message-ID) без проверки From:, continue
* 2xx, stop

rcpt
* домен не принимает почту (verify = recipient) => 5xx Recipient domain {domain} does not accept mail, stop
* 2xx, stop

data_end
* message_size >= sys_maxmessagesize => 5xx ...
* синтаксис заголовоков некорректен (verify = header_syntax) => 5xx Invalid message headers (Sender/From/Reply-To/To/Cc/Bcc), stop
* есть заголовок X-AdvancedFiltering-MessageData-Submission => 5xx Message loop detected, stop
* заголовок From: содержит несколько адресов или битый => 5xx Invalid "From:" header, stop
* заголовок "From:" содержит один адрес  => проверка адреса отправителя ("From:"), continue
# может быть домен, котрый не совпадает с mail from и тоже зарегистрирован в системе (relaxed DMARC или ошибка конфигурации)
* DMARC не проверился (dmarc_verifier.pl "from domain" "spf domain" "dkim domain") => 5xx DMARC failed for "From:" domain {domain:header_from}, stop
* присутствует заголовок "Reply-To:" && содержит несколько адресов или битый => 5xx Invalid "Reply-To:" header, stop
* присутствует заголовок "Reply-To:" && домен в заголовке Reply-To: не принимает почту (verify = sender) => 5xx "Reply-To:" domain {domain:header_reply-to} does not accept mail, stop
# message-id всегда добавляется для этого соединения (режим submission)
* message-id в БД но sender другой => 5xx Duplicate, previous sender=prev-sender
* in-reply-to, references в БД и sender в recipients => flag_hamtrap, continue
* msgsize >= sys_trustedmessagesize => flag_trustedmessagesize, log (trusted size), 2xx Trusted message size, stop
* 2xx, stop
