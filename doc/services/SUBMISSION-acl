* локальные порты 587

* получение системной настройки mailboxtimeout
sys_mailboxtimeout

* получение системной настройки размера сообщения для отключения проверки спама
sys_trustedmessagesize

* получить системную настройку максимаьного размера сообщения
sys_maxmessagesize

* установить сертификат
** trusted_host => внутренний сертификат (hostname.crt)
** client (IP) && задан клиентский сертификат => клиентский сертификат
** client (IP) => внешний сертификат (submission.services.advancedfiltering.net.crt)
** client (TLS SNI) && задан клиентский сертификат => клиентский сертификат
** client (TLS SNI) => внешний сертификат (submission.services.advancedfiltering.net.crt)

mail
* идентифицировать клиента
# код ошибки 5xx - эту ошибку нужно обнаружить сразу и устранить (smtp отправит boucne на error@services)
** trusted_host && !certificate_verified => 5xx Trusted host certificate verification failed, stop
** trusted_host => continue
# код ошибки 5xx - эту ошибку нужно обнаружить сразу и устранить
** IP (client) && задан клиентский сертификат && !certificate_verified => 5xx Client (IP) certificate verification failed, stop
** IP (client) => continue
** TLS SNI && задан клиентский сертификат && !certificate_verified => 5xx Client (TLS SNI) certificate verification failed, stop
** TLS SNI => continue
** SMTP AUTH => continue
** 5xx Authentication needed, stop
* домен не зарегистрирован => 5xx Sender domain {domain:sender_address} is not in service, stop
* не наш realm домена => 4xx Moved, please try another host, stop
* не существует адрес отправителя => 5xx Sender address {sender_address} does not exist, stop
* !trusted_host && адрес отправителя не принадлежит аутентифицированному client/domain/rcpt => 5xx Authenticated user {user} may not use sender address {sender_address}, stop
* нет DMARC (dmarc_verifier.pl "domain") => 5xx DMARC is absent for sender domain {domain:sender_address}, stop
* загрузить пользовательсике настройки => user_hidereceived, flag_spamsender, continue
* user_hidereceived => Удалить заголовки Received, continue
* Режим submission без исправления From/Sender, continue

rcpt
* не существует домен получателя => 5xx Domain {rcpt domain} does not exist, stop

data_end
* синтаксис заголовоков некорректен (verify = header_syntax) => 5xx Invalid message headers (Sender:/From:/Reply-To:/To:/Cc:/Bcc:), stop
* нет заголовка From: => 5xx "From:" header is absent, stop
* домен в заголовке From: не зарегистрирован => 5xx "From:" domain {domain:header_from} is not in service, stop
* не наш realm домена в заголовке From: => 4xx "From:" domain {domain:header_from} moved, please try another host, stop
* не существует адрес в заголовке From: => 5xx "From:" address {header_from} does not exist, stop
* !trusted_host && адрес в заголовке From: не принадлежит аутентифицированному client/domain/rcpt => 5xx Authenticated user {user} may not use "From:" address {header_from}, stop
# может быть домен, котрый не совпадает с mail from и тоже зарегистрирован в системе (relaxed DMARC или ошибка конфигурации)
* DMARC не проверился (dmarc_verifier.pl "from domain" "spf domain" "dkim domain") => 5xx DMARC failed for "From:" domain {from domain}, stop
* домена Reply-To нет в DNS => 5xx "Reply-To:" domain {domain:header_reply-to} does not exist, stop
# message-id всегда добавляется для этого соединения
* message-id+получатель в БД => 2xx Duplicate, previous id=prev-queue-id, discard, stop
* message-id+получатель в БД но sender другой => 5xx Duplicate, previous sender=prev-sender
* msgsize >= sys_trustedmessagesize => flag_trustedmessagesize, log (trusted size), 2xx Trusted message size, stop
