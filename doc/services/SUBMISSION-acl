* локальные порты 25 587

* получение системной настройки размера сообщения для отключения проверки спама
sys_trustedmessagesize

* получить системную настройку максимаьного размера сообщения
sys_maxmessagesize

* получить системную настройку периода перепроверки ящика
sys_mailboxtimeout

* установить сертификат
** sys_trustedhost => наш сертификат
** client (IP) => клиентский сертификат
** client (TLS SNI) => клиентский сертификат

connect
* наш hostname && наш realm && service=smtp && проверен hostname (ptr <-> ip) => sys_trustedhost
sys_trustedhost

mail
* идентифицировать клиента
** sys_trustedhost => ok
** IP (client) => ok
** TLS SNI && TLS verified (client) => ok
** SMTP AUTH (client/domain/rcpt) => ok
** fail => 5xx Authentication needed, stop
* проверить существование адреса отправителя (envelope)
** fail => 5xx Sender mail box does not exist, stop
* !sys_trustedhost => проверить доступ к адресу отправителя (client/domain/rcpt)
* загрузить пользовательсике настройки => user_hidereceived, flag_spamsender

rcpt
* проверить существование домена получателя

data_end
* проверить адрес отправителя (From)
** нет домена => 5xx "From:" domain (domain:header_from) is not in service, stop
** не наш realm => 4xx "From:" domain moved, please try another host, stop
** fail => 5xx "From:" mail box (header_from) does not exist, stop
** ok
* проверить обратный адрес (Reply-To)
** нет домена => 5xx "Reply-To:" domain (domain:header_from) is not in service, stop
** не наш realm => 4xx "Reply-To:" domain moved, please try another host, stop
** fail => 5xx "Reply-To:" mail box (header_from) does not exist, stop
** ok
# message-id всегда добавляется для этого соединения
* проверить message-id+получатель
** в БД => 2xx Duplicate, previous id=prev-queue-id, discard, stop
** sender в БД но другой => 5xx Duplicate, previous sender=prev-sender
** ok
* user_hidereceived => убрать заголовки Received
* msgsize >= sys_trustedmessagesize => flag_trustedmessagesize, log (trusted size), ok, stop
