Входящий роутинг

-> - redirect_router
=> - errors_to
>> - pass_router
[] - condition
{} - unseen

# spamaddress - для бэкапа спама
# backup - для бэкапа остальной почты

* service [@services] {stop} => error
* service_defer [@services] {stop} -> service => error
# -> service => error - для единообразия
* vrfy_defer [!flag_vrfy] {stop} -> service => error
* vrfy_ok [flag_vrfy && flag_vrfy_result] {stop} -> service => error
* vrfy_fail [flag_vrfy && !flag_vrfy_result] {stop} -> service => error
* mailproc [flag_mailproc] {stop} -> service => error
* hamtrap [flag_hamtrap && sys_hamtrap] {continue} -> service => error
* spamtrap [flag_spamtrap && sys_spamtrap] {continue} -> service => error
* absent :blackhole: [flag_mb_absent] {stop} => error
* spam :blackhole: [flag_spam && !user_spt] {stop} => error
* spamaddress_rcpt [flag_spam] {stop} -> submission => error
* spamaddress_domain [flag_spam] {stop} -> submission => error
* spamaddress_client [flag_spam] {stop} -> submission => error
* backup_rcpt [!flag_spam] {continue} -> submission >> backup_end => error
* backup_domain [!flag_spam] {continue} -> submission >> backup_end => error
* backup_client [!flag_spam] {continue} -> submission >> backup_end => error
* backup_end
* redirect_rcpt {stop} -> submission => error
* redirect_domain {stop} -> submission => error
* redirect_client {stop} -> submission => error
* spambox_rcpt [flag_spam] {stop} -> mx => error
* spambox_domain [flag_spam] {stop} -> mx => error
* spambox_client [flag_spam] {stop} -> mx => error
* mx
* mx_rcpt {stop} => bounce
* mx_domain {stop} => bounce
* mx_client {stop} => bounce
* mx_defer {stop} -> mx => bounce
* submission {stop} => error
* submission_defer {stop} -> submission => error

Для spam проверять afUSMTPDMBIsAbsent,
т.к. отправка производится с адреса afUSMTPDMailBox,
нет возможности отправлять с несуществующего адреса.
Нет смысла проверять для backup и mx (теоретически)
т.к. несуществующий MailBox до этих роутеров не дойдет:
если включен spamtrap, то сообщение поглотит spam_last_router,
если spamtrap отключен, тогда будет отвергнут RCPT.

Была идея пересылать выходящее сообщение на соседний smtp в случае недоставки.
Нужно предотвратить пересылку сообщения spam- или backup-роутером, для этого добавлять заголовок. Этот заголовок нужно
учитывать только при получении сообщения с соседнего smtp и удалять его при передаче клиенту.
Но это ломает retry rules и неконтролируемо добавляет trace headers (Received).
Этот функционал требуется для вывода сервера из работы.
Для вывода из работы достаточно изменить конфигурацию - сделать единственный роутер для отправки на соседний smtp.
Дублированием отправки в spam и backup можно принебречь (до тех пор, когда, по каким либо причинам, выводы из работы
станут регулярными - тогда реализовать заголовок).
