Хаки SMTP:

Основной принцип: усилия прикладывает тот, кому больше надо.
Если отправитель желает отправить письмо - пускай джет, пока перерыв.
Ошибка 4xx позволяет обработать сообщение не сохраняя его и позволяет проверить "стойкость" намерения отправителя.
Этот принцип дает преимущество честным отправителям, т.к. они шлют мало писем (до 10% от общего потока).
Спамерам требуется отправить много писем за короткое время, используются спам-боты и реже полнофункциональные сервисы.
Спам-бот не будет перепосылать, а ошибка 4xx у полнофункционального почтовика вызовет коллапс в очереди отправки.

Проблема: хранение сообщений
Для хранения сообщений требуется диск.
Так-же требуется индексировать - еще более дорогостоящий десурс.
Решение: не хранить сообщения
Никаких сообщений не храним.
Для этого при получении сообщения отправляем его на проверку, а отправителю сообщаем временную ошибку 4xx.
После проверки запишем Message-ID в БД. Когда отправитель повторно пришлет это сообщение - найдем Message-ID в БД
и пропустим сообщение или отвергнем его перманентной ошибкой 5xx.
Преимущества: требуется значительно меньше ресурсов, дополнительная нагрузка на отправителя (что плохо для спамера)
Недостатки: периол доставки (latency) определяется таймаутом отправителя

Проблема: несколько получателей для одного сообщения
Одно сообщение может отправляться нескольким получателям. Получатель могут быть на разных доменах, в разных realm-ах,
иметь разные политики, или отсутствовать (spamtrap). Политики могут быть конфликтующие - требуется продумать приоритеты политик.
Решение: принимать только для одного получателя
Приняли одного получателя, остальных отвергаем временной ошибкой 4xx.
Отправитель повторно перешлет сообщение для остальных получателей отдельно.
Преимущества: упрощается логика, дополнительная нагрузка на отправителя (кошмар для спамера)
Недостатки: сообщения нескольким получателям доходят разным получателям с задержкой

